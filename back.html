<div class="card">
  <div class="h1 xleft">
   <div class="h2"><strong>{{问题}}</strong></div>
    <div id="options" class="options"></div>
    <hr>
    <div class="h2 slide">
			<div>
				<span class="shuffle-option">选项乱序</span>
  				<label class="switch">
    				<input type="checkbox" id="shuffle-toggle" checked>
   		  		<span class="slider round"></span>
 				</label>
  				
			</div>

      <div class="answer">正确答案: <br><span id="formatted-answer"></span></div>
      <div class="result">你选择了: <span id="selected-answer"></span></div>
      <div class="result">是否正确: <span id="correctness"></span></div>
    </div>
  </div>

  {{#解析}}
  <div class="slide">
    <div class="h1 yleft">
      <div class="analyse">{{解析}}</div>
    </div>
  </div>
  {{/解析}}
</div>

<script>
(function() {
    var optionsHtml = `{{选项}}`;
    var options = optionsHtml.split('<br>').map(option => option.trim()).filter(option => option !== '');
    var answer = '{{答案}}';
    var alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    
    var shuffleToggle = document.getElementById('shuffle-toggle');

    // Save shuffle state
    shuffleToggle.addEventListener('change', function() {
        localStorage.setItem('shuffle-options', shuffleToggle.checked);
    });

    var isShuffled = JSON.parse(localStorage.getItem('shuffle-options') || 'true');
    shuffleToggle.checked = isShuffled;

    if (isShuffled) {
        // Load shuffled options and correct indexes from local storage
        options = JSON.parse(localStorage.getItem('shuffled-options') || JSON.stringify(options));
        var correctIndexes = JSON.parse(localStorage.getItem('shuffled-correct-indexes'));
    } else {
        correctIndexes = answer.split(',').map(a => !isNaN(a) ? parseInt(a) - 1 : alphabet.indexOf(a.toUpperCase()));
    }

    var questionType = answer.includes(',') ? '（多选题）' : '（单选题）';
    document.querySelector('.h2').innerHTML += questionType;
    
    var selectedOptions = JSON.parse(localStorage.getItem('selected-options') || '[]');
    if (typeof anki !== 'undefined' && anki.loadData) {
        selectedOptions = anki.loadData('selected-options') || selectedOptions;
    }
    
    gData.clickedValues = selectedOptions;
    var selectedAnswer = selectedOptions.join(', ');
    document.getElementById('selected-answer').innerHTML = selectedAnswer;

    var formattedAnswer = correctIndexes.map(index => `${alphabet[index]} - ${options[index]}`).join('<br>');
    document.getElementById('formatted-answer').innerHTML = formattedAnswer;

    var labeledOptions = options.map(function(option, index) {
        var isSelected = selectedOptions.includes(alphabet[index]);
        var isCorrect = correctIndexes.includes(index);
        var className = '';
        var symbol = '';

           if (isSelected && isCorrect) {
        className = 'correct';
        symbol = '✔';
    } else if (isSelected && !isCorrect) {
        className = 'incorrect';
        symbol = '✘';
    } else if (!isSelected && isCorrect) {
        className = 'missed';
        symbol = '';
    }

    return `<button class="${className}" disabled>
                <span style="flex-grow: 1;">${alphabet[index]}. ${option}</span>
                <span style="flex-basis: 10%; text-align: right;">${symbol}</span>
            </button>`;
}).join('');
    document.getElementById('options').innerHTML = labeledOptions;

    // Check if the selected options are exactly the same as the correct ones
    var isCorrect = correctIndexes.every(index => selectedOptions.includes(alphabet[index])) && 
                    selectedOptions.length === correctIndexes.length;

    var correctness = isCorrect ? '正确' : '错误';
    document.getElementById('correctness').innerHTML = correctness;
})();
</script>
